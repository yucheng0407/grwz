<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <style type="text/css">
        body, html, #allmap {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: "微软雅黑";
        }
    </style>
    <script type="text/javascript" src="/test/medias/js/baseJs/jquery-3.2.1.min.js"></script>
    <script type="text/javascript"
            src="http://api.map.baidu.com/api?v=2.0&ak=7G21AeGkO9u42Mwv4EeOiCG1Xbk5bG8A"></script>
    <!--加载鼠标绘制工具-->
    <script type="text/javascript"
            src="/test/medias/js/map/DrawingManager.js"></script>
    <link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css"/>
    <title>地图</title>
</head>
<body>
<div id="allmap" style="position: absolute"></div>
<script type="text/javascript">
    // 百度地图API功能
    var i = 1;//唯一标志
    var overlays = [];
    var opts;
    var map = new BMap.Map("allmap");
    var drawingManager;
    var geoc = new BMap.Geocoder();//地址解析
    var point = new BMap.Point(116.404, 39.915);
    var top_left_control = new BMap.ScaleControl({anchor: BMAP_ANCHOR_TOP_LEFT});// 左上角，添加比例尺
    var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
    map.centerAndZoom("芜湖市万科城", 15);
    map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
    map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用
    var styleOptions = {
        strokeColor: "red",    //边线颜色。
//        fillColor:"red",      //填充颜色。当参数为空时，圆形将没有填充效果。
        strokeWeight: 3,       //边线的宽度，以像素为单位。
        strokeOpacity: 0.8,	   //边线透明度，取值范围0 - 1。
        fillOpacity: 0.6,      //填充的透明度，取值范围0 - 1。
        strokeStyle: 'solid' //边线的样式，solid或dashed。
    };
    var _openBaiduMap = {//在window.data中
        mapData: null,//父页面数据
        enableDrawingTool: null,//是否展示工具栏
        callBack: null//返回函数
    };

    //地图加载完(初始化)
    (function loadMap() {
        if(!window.data)window.data={};
        var tilesloaded = function () {
            //缩放工具栏
            map.addControl(top_left_control);
            map.addControl(top_left_navigation);
            //实例化鼠标绘制工具
            if (window.data.enableDrawingTool) {
                drawingManager = new BMapLib.DrawingManager(map, {
                    isOpen: false, //是否开启绘制模式
                    enableDrawingTool: true, //是否显示工具栏
                    drawingToolOptions: {
                        anchor: BMAP_ANCHOR_TOP_RIGHT, //位置
                        offset: new BMap.Size(5, 5), //偏离值
                        scale: 0.9//缩放比例
                    },
                    circleOptions: styleOptions, //圆的样式
                    polylineOptions: styleOptions, //线的样式
                    polygonOptions: styleOptions, //多边形的样式
                    rectangleOptions: styleOptions //矩形的样式
                });
                // 绘图完添加标签
                var overlaycomplete = function (e) {
                    addMenu(e.overlay);
                    setOverlay(e.overlay);//存放数据
                    openInfoWindow(e.overlay, 'xg');
                };
                drawingManager.addEventListener('overlaycomplete', overlaycomplete);
            }
            initData();
            map.removeEventListener("tilesloaded", tilesloaded);
        };
        map.addEventListener("tilesloaded", tilesloaded);

    })();
    // 将后台添加标签
    function initData() {
        var mapData = window.data.mapData;
        var pt = new BMap.Point(118.428044, 31.376431);//地址
        var marker = new BMap.Marker(pt);
        if (window.data.enableDrawingTool) {
            addMenu(marker);
        }
        setOverlay(marker, mapData);//绑定数据
        map.addOverlay(marker);
        addSelectOverlay(marker);
    }
    /**
     *  将事件,数据添加到标签中(查询弹框)
     */
    function addSelectOverlay(overlay) {
        var openWin = function () {//标签移动
            openInfoWindow(overlay, 'ck');
        };
        var closeWin = function () {

            overlay.closeInfoWindow();
        };
        overlay.addEventListener("mouseover", openWin);
        overlay.addEventListener("mouseout", closeWin);
        overlay.openWin = openWin;
        overlay.closeWin = closeWin;
    }
    /**
     *  将事件,数据移除到标签中(查询弹框)
     */
    function removeSelectOverlay(overlay) {
        overlay.removeEventListener("mouseover", overlay.openWin);
        overlay.removeEventListener("mouseout", overlay.closeWin);
    }
    /**
     *  右键菜单(编辑数据)
     */
    function addMenu(overlay) {
        //删除标签
        var removeMarker = function (e, ee, overlay) {
            map.removeOverlay(overlay);
        };
        //修改备注(修改弹框)
        var editMarker = function (e, ee, overlay) {
            openInfoWindow(overlay, 'xg')
        };
        var markerMenu = new BMap.ContextMenu(); //创建右键菜单
        if (overlay instanceof BMap.Marker) markerMenu.addItem(new BMap.MenuItem('修改', editMarker.bind(overlay)));
        markerMenu.addItem(new BMap.MenuItem('删除', removeMarker.bind(overlay)));
        overlay.addContextMenu(markerMenu);
    }

    /**
     * 弹出窗口
     */
    function openInfoWindow(overlay, type) {
        var id = overlay.id;
        overlay.type=type;
        //窗口(查询和修改)
        var addHtml = function (html) {
            var p = overlay.getPosition();

            geoc.getLocation(p, function (rs) {//坐标转地址
                if (!overlay.data.dz) overlay.data.dz = rs.address;
                if (!opts) opts = {
                    width: 300,
                    title: "基本信息" // 信息窗口标题
                };
                var infoWindow;
                switch (type) {
                    case 'ck':
                        infoWindow = new BMap.InfoWindow(html, opts);
                        break;
                    case 'xg':
                        html = html + '<button style="float: right" onclick="save(' + id + ')">确定</button>';
                        infoWindow = new BMap.InfoWindow(html, opts);
                        removeSelectOverlay(overlay);//关闭查询
                        infoWindow.addEventListener('close', function () {
                            addSelectOverlay(overlay);//开启查询
                        });
                        break;
                }
                overlay.openInfoWindow(infoWindow);
            })
        };
        if (overlay instanceof BMap.Marker) {
            addHtml('<iframe frameborder="no" name="overlay"  src=/test/map/infoWindow?id=' + id + '&type=' + type + '></iframe>');
        } else if (overlay instanceof BMap.Circle) {//该覆盖物是圆
            alert("该覆盖物是圆，圆的半径是：" + overlay.getRadius() + "，圆的中心点坐标是：" + overlay.getCenter().lng + "," + overlay.getCenter().lat);
        } else if (overlay instanceof BMap.Polyline) {//覆盖物是折线
            alert("该覆盖物是折线，所画点的个数是：" + overlay.getPath().length);
        } else if (overlay instanceof BMap.Polygon) {//覆盖物是多边形
            alert("该覆盖物是线，所画多边形的个数是：" + overlay.getPath().length);
        } else {
            alert("无法获知该覆盖物类型");
        }
    }

    /**
     * 渲染弹出窗口(外部)
     */
    function render(id) {
//        opts.width = $(window.frames["overlay"].document).width();
        $.each(getOverlay(id).data, function (key, value) {
            $(window.frames["overlay"].document).find("#" + key).val(value).attr('title', value);
        });
        $(window.frames["overlay"].document).find("#id").val(getOverlay(id).id)
    }

    /**
     * 得到弹出窗口值(外部)
     */
    function save(id) {
        var data = {};
        $(window.frames["overlay"].document).find("[name='map']").each(function () {
            data[$(this).attr('id')] = $(this).val();
        });
        var overlay = getOverlay(id);
        data.x = overlay.point.lng;
        data.y = overlay.point.lat;
        setOverlay(overlay, data);
        window.data.callBack(data);
        overlay.closeInfoWindow();
    }


    /**
     * 获取指定标签
     * @param e
     * @returns {*}
     */
    function getOverlay(e) {
        for (var i = 0; i < overlays.length; i++) {
            if (overlays[i].id == e) {
                return overlays[i];
            }
        }
    }

    /**
     * 存放指定标签
     * @param e
     * @returns {*}
     */
    function setOverlay(overlay, data) {

        if (data) {
            overlay.data = data
        } else overlay.data = {};//存放数据
        if (!overlay.id) {//添加
            overlay.id = i;
            overlays.push(overlay);//修改和添加
            i++;//标记标签
            return i - 1;
        } else overlay.id;//修改
    }
</script>
</body>
</html>
